# sentinel-golang 概览

[toc]

Sentinel 是面向分布式服务架构的高可用防护组件，主要以流量为切入点，从流量控制、熔断降级、系统自适应保护等多个维度来帮助用户保障服务的稳定性。

[GITHUB](https://github.com/alibaba/Sentinel)
[官网](https://sentinelguard.io/)

# 特性

### 丰富的应用场景

阿里巴巴 10 年双十一积累的丰富流量场景，包括秒杀、双十一零点持续洪峰、热点商品探测、预热、消息队列削峰填谷等多样化的场景

### 易于使用，快速接入

简单易用，开源生态广泛，针对 Dubbo、Spring Cloud、gRPC、Zuul、Reactor、Quarkus 等框架只需要引入适配模块即可快速接入

### 多样化的流量控制

资源粒度、调用关系、指标类型、控制效果等多维度的流量控制

### 可视化的监控和规则管理

sentinel-golang 目前还不支持实时监控的可视化展示
简单易用的 Sentinel 控制台

# 基本API使用指南

1. 对 Sentinel 的运行环境进行相关配置并初始化。例如：日志的输出路径
2. 埋点（定义资源），该步骤主要是确定系统中有哪些资源需要防护。
3. 配置规则，该步骤主要是为每个资源都配置具体的规则。
4. 编写资源防护的入口和出口代码。

## 埋点

使用 Sentinel 的 Entry API 将业务逻辑封装起来，这一步称为“埋点”。每个埋点都有一个资源名称（resource），代表触发了这个资源的调用或访问。就好比在监控系统的 openTraceing 埋点一样

**示例**

```go
import (
    sentinel "github.com/alibaba/sentinel-golang/api"
)

// Entry 方法用于埋点
e, b := sentinel.Entry("your-resource-name", sentinel.WithTrafficType(base.Inbound))
if b != nil {
    // 请求被流控，可以从 BlockError 中获取限流详情
    // block 后不需要进行 Exit()
} else {
    // 请求可以通过，在此处编写您的业务逻辑
    // 务必保证业务逻辑结束后 Exit
    e.Exit()
}
```

## 配置规则

sentinel 系统把不同的服务不同的集群等等，都抽象成资源(resource)，然后我们可以针对某个资源添加各种各样的防护规则，例如：限流，熔断降级等等。下文我们一起看一下 sentinel-golang 中实现了哪些防护规则。

各种规则是可以通过硬编码配置，也可以通过配置文件，或者可以把规则存放在远程服务中(etcd,nacos)，然后实现规则的动态修改实时生效

# (流量控制)限流

## 普通的滑动窗口限流

特点：在某一个时间窗口期，超过限流阈值直接拒绝请求

演示代码：

## 漏桶排队限流

特点：以固定的间隔时间让请求通过。当请求到来的时候，如果当前请求距离上个通过的请求通过的时间间隔不小于预设值，则让当前请求通过；否则，计算当前请求的预期通过时间，如果该请求的预期通过时间小于规则预设的 timeout 时间，则该请求会等待直到预设时间到来通过（排队等待处理）；若预期的通过时间超出最大排队时长，则直接拒接这个请求。

匀速排队方式会严格控制请求通过的间隔时间，也即是让请求以均匀的速度通过，对应的是漏桶算法。该方式的作用如下图所示：

![时间轴](https://alphababy-blog.oss-cn-chengdu.aliyuncs.com/uPic/2021/08-19-btR0QG.jpg)

演示代码：

## 系统预热限流

当系统长期处于低水位的情况下，当流量突然增加时，直接把系统拉升到高水位可能瞬间把系统压垮。通过"冷启动"，让通过的流量缓慢增加，在一定时间内逐渐增加到阈值上限，给冷系统一个预热的时间，避免冷系统被压垮。

![流量图](https://alphababy-blog.oss-cn-chengdu.aliyuncs.com/uPic/2021/08-19-xM7sAU.jpg)

## 基于调用关系的流量控制

Sentinel 支持关联流量控制策略。当两个资源之间具有资源争抢或者依赖关系的时候，这两个资源便具有了关联。比如对数据库同一个字段的读操作和写操作存在争抢，读的速度过高会影响写得速度，写的速度过高会影响读的速度。如果放任读写操作争抢资源，则争抢本身带来的开销会降低整体的吞吐量。可使用关联限流来避免具有关联关系的资源之间过度的争抢。

## 脉冲流量问题

![脉冲流量](https://alphababy-blog.oss-cn-chengdu.aliyuncs.com/uPic/2021/08-19-L7UR6Q.jpg)

既想控制流量曲线，又想无损，一般做法是通过匀速排队的控制策略，平滑掉流量。

# 熔断降级

## 概述

在高可用设计中，除了流控外，对分布式系统调用链路中不稳定的资源(比如RPC服务等)进行熔断降级也是保障高可用的重要措施之一。

![微服务](https://alphababy-blog.oss-cn-chengdu.aliyuncs.com/uPic/2021/08-19-JBHuOl.jpg)

## 熔断器模型

Sentinel 熔断降级基于熔断器模式 (circuit breaker pattern) 实现。熔断器内部维护了一个熔断器的状态机，状态机的转换关系如下图所示：

![熔断器模型](https://alphababy-blog.oss-cn-chengdu.aliyuncs.com/uPic/2021/08-19-jEGKCK.jpg)

1. 初始状态下，熔断器处于 Closed 状态。如果基于熔断器的统计数据表明当前资源触发了设定的阈值，那么熔断器会切换状态到 Open 状态。
2. Open 状态即代表熔断状态，所有请求都会直接被拒绝。熔断器规则中会配置一个熔断超时重试的时间，经过熔断超时重试时长后熔断器会将状态置为 Half-Open 状态，从而进行探测机制。
3. 处于 Half-Open 状态的熔断器会周期性去做探测。

熔断器的整体检查逻辑可以用几点来精简概括：

1. 基于熔断器的状态机来判断对资源是否可以访问；
2. 对不可访问的资源会有探测机制，探测机制保障了对资源访问的弹性恢复；
3. 熔断器会在对资源访问的完成态去更新统计，然后基于熔断规则更新熔断器状态机。

## 熔断策略

Sentinel 支持以下几种熔断策略：

* **慢调用比例策略**(SlowRequestRatio)：Sentinel 的熔断器不在静默期，并且慢调用的比例大于设置的阈值，则接下来的熔断周期内对资源的访问会自动地被熔断。该策略下需要设置允许的调用 RT 临界值（即最大的响应时间），对该资源访问的响应时间大于该阈值则统计为慢调用。
* **错误比例策略**(ErrorRatio)：Sentinel 的熔断器不在静默期，并且在统计周期内资源请求访问异常的比例大于设定的阈值，则接下来的熔断周期内对资源的访问会自动地被熔断。
* **错误计数策略**(ErrorCount)：Sentinel 的熔断器不在静默期，并且在统计周期内资源请求访问异常数大于设定的阈值，则接下来的熔断周期内对资源的访问会自动地被熔断。

**注意** 举个例子，假设在一个统计周期刚刚开始时候，第 1 个请求碰巧是个慢请求，这个时候这个时候的慢调用比例就会是 100%，很明显是不合理，所以存在一定的巧合性。所以静默期提高了熔断器的精准性以及降低误判可能性。

## 最佳场景实践

熔断器一般用于应用对外部资源访问时的保护措施。这里简单描述一些场景：

* 分布式系统中降级：假设存在应用A需要调用应用B的接口(特别是一些对接外部公司或者业务的接口时候)，那么一般用于A调用B的接口时的防护；
* 数据库慢调用的防护： 假设应用需要读/写数据库，但是该读写SQL存在潜在慢SQL的可能性，那么可以对该读写接口做防护，当接口不稳定时候(存在慢SQL)，那么基于熔断器做降级。
* 也可以是应用中任意弱依赖接口做降级防护（即自动降级后不影响业务核心链路）。

## 错误计数熔断 演示代码：

# 并发隔离控制

并发隔离控制是指基于资源访问的并发协程数来控制对资源的访问，这里的思路和信号量隔离很类似，主要是控制对资源访问的最大并发数，避免因为资源的异常导致协程耗尽。

例如：我设置最大并发数为1，那么在随便一个时刻只能允许一个人访问我的服务。如果这个请求卡住了很长时间，那么在这段时间内都是不能允许其他请求。其实这里我感觉实现上还有一些小问题

# 系统自适应保护

Sentinel 系统自适应保护从整体维度对应用入口流量进行控制，结合应用的 Load、总体平均 RT、入口 QPS 和线程数等几个维度的监控指标，让系统的入口流量和系统的负载达到一个平衡，让系统尽可能跑在最大吞吐量的同时保证系统整体的稳定性。那是怎么计算和自适应的呢？

sentinel 从 TCP 拥塞控制 BRR 算法中得到灵感，BBR算法是个主动的闭环反馈系统，通俗来说就是根据带宽和RTT延时来不断动态探索寻找合适的发送速率和发送量。 数据包传输的每个累积或选择性确认用于生成记录在数据包传输过程和确认返回期间的时间内所传送数据量的采样率。

从业务方来说，以上的防护措施，都是需要一定的实战经验后才能配置一个比较合理的阈值。但是**系统自适应保护**会根据当前系统的各种指标实时计算一个合理的阈值来保护自身的服务。计算业务开发的心智负担。

# 热点参数限流

热点参数限流会统计传入参数中的热点参数，并根据配置的限流阈值与模式，对包含热点参数的资源调用进行限流。热点参数限流可以看做是一种特殊的流量控制，仅对包含热点参数的资源调用生效。

![热点参数](https://alphababy-blog.oss-cn-chengdu.aliyuncs.com/uPic/2021/08-20-oqfHBZ.jpg)

Sentinel 利用 LRU 策略统计最近最常访问的热点参数，结合令牌桶算法来进行参数级别的流控。

## 使用场景

例如：我有一个服务 A ,然后很很多用户来调用我，其中每次请求都会携带 pin 我会限制每一个 pin 的调用次数为 100 QPS.

例如：在一些大公司，不同服务都是通过 appname 来管理的，某个服务在调用某个服务的时候都会传递appname, 我可以限制调用我的服务 app 都为 100 QPS。

# 动态参数扩展

sentinel 系统最重要的两个概念**资源**,**规则**。都是可以通过依赖外部的系统实现资源与规则的发现，实时修改下发，实时生效的功能。目前 sentinel-golang 已经支持了**etcd**, **k8s**, **nacos**。